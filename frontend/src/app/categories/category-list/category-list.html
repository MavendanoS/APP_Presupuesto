<app-navbar />

<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h2 class="mb-0">
          <i class="bi bi-tags me-2"></i>
          Categorías
        </h2>
        <a routerLink="/categories/new" class="btn btn-primary">
          <i class="bi bi-plus-circle me-1"></i>
          Nueva Categoría
        </a>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="d-flex gap-2 flex-wrap">
        @for (type of categoryTypes; track type.value) {
          <button
            class="btn btn-sm"
            [class.btn-primary]="filterType() === type.value"
            [class.btn-outline-primary]="filterType() !== type.value"
            (click)="changeFilter(type.value)"
          >
            {{ type.label }}
          </button>
        }
      </div>
    </div>
  </div>

  @if (error()) {
    <app-error-message [message]="error()!" (retry)="loadCategories()" />
  }

  @if (loading()) {
    <app-loading />
  }

  @if (!loading() && !error()) {
    @if (categories().length === 0) {
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        No hay categorías registradas.
        <a routerLink="/categories/new" class="alert-link">Crea tu primera categoría</a>
      </div>
    } @else {
      <!-- Tablas agrupadas por tipo -->
      @for (type of getVisibleTypes(); track type) {
        @if (getCategoriesByType(type).length > 0) {
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-{{ getTypeBadgeClass(type) }} text-white">
              <h5 class="mb-0">
                <i class="bi bi-tag me-2"></i>
                {{ getTypeLabel(type) }}
              </h5>
            </div>
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th style="width: 60px;"></th>
                    <th>Nombre</th>
                    @if (viewMode() === 'stats') {
                      <th class="text-end" style="width: 150px;">Total Gastado</th>
                      <th class="text-center" style="width: 120px;">Cantidad</th>
                    }
                    <th class="text-end" style="width: 200px;">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  @for (category of getCategoriesByType(type); track category.id) {
                    <tr>
                      <td class="text-center">
                        <div class="category-icon-small" [style.background-color]="category.color">
                          <i class="bi {{ category.icon }}"></i>
                        </div>
                      </td>
                      <td class="align-middle">
                        <strong>{{ category.name }}</strong>
                      </td>
                      @if (viewMode() === 'stats') {
                        <td class="text-end align-middle">
                          <strong>{{ formatCurrency(category.total_amount || 0) }}</strong>
                        </td>
                        <td class="text-center align-middle">
                          <span class="badge bg-secondary">{{ category.expense_count || 0 }}</span>
                        </td>
                      }
                      <td class="text-end align-middle">
                        <div class="btn-group btn-group-sm" role="group">
                          <button
                            class="btn btn-outline-primary"
                            (click)="editCategory(category.id)"
                            title="Editar categoría"
                          >
                            <i class="bi bi-pencil me-1"></i>
                            Editar
                          </button>
                          <button
                            class="btn btn-outline-danger"
                            (click)="deleteCategory(category)"
                            title="Eliminar categoría"
                          >
                            <i class="bi bi-trash me-1"></i>
                            Eliminar
                          </button>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
                @if (viewMode() === 'stats') {
                  <tfoot class="table-light">
                    <tr>
                      <td colspan="2" class="text-end"><strong>Total {{ getTypeLabel(type) }}:</strong></td>
                      <td class="text-end">
                        <strong>
                          {{ formatCurrency(getTotalAmountByType(type)) }}
                        </strong>
                      </td>
                      <td class="text-center">
                        <span class="badge bg-dark">
                          {{ getTotalCountByType(type) }}
                        </span>
                      </td>
                      <td></td>
                    </tr>
                  </tfoot>
                }
              </table>
            </div>
          </div>
        }
      }
    }
  }
</div>
